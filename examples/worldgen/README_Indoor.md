# 室内无人机避障训练环境生成器

这个工具可以生成用于无人机自主避障飞行训练的室内环境，包含随机分布的障碍物和可穿越的门。

## 功能特点

1. **自适应障碍物生成**: 根据无人机尺寸和任务难度自动生成合适密度和尺寸的障碍物
2. **智能门系统**: 支持方形和圆形门，自动检测并保证门的通道畅通
3. **多种障碍物类型**: 包括球体、立方体和圆柱体障碍物，支持悬空放置
4. **可配置参数**: 通过YAML文件灵活配置场景参数
5. **多模态渲染**: 支持RGB、深度、法线和分割图像输出

## 文件结构

- `indoor.py` - 主程序文件
- `indoor_config.yaml` - 配置文件
- `README_Indoor.md` - 说明文档

## 使用方法

### 基本使用

```bash
# 运行可视化模式
python indoor.py --vis

# 生成更多步数的数据
python indoor.py --vis -s 50 -b 1

# CPU模式运行
python indoor.py --cpu --vis -s 10

# 批量环境模式
python indoor.py -b 5 -s 20
```

### 参数说明

- `--vis`: 启用可视化界面
- `--cpu`: 使用CPU后端（默认GPU）
- `-b, --n_envs`: 并行环境数量（默认3）
- `-s, --n_steps`: 仿真步数（默认2）
- `-o, --output_dir`: 输出目录（默认"img_output/test"）
- `--dt`: 仿真时间步长（默认0.01）
- `--w, --h`: 相机分辨率（默认640x480）

## 配置文件说明

`indoor_config.yaml` 包含以下配置项：

### 场景尺寸
```yaml
scene_extent:
  x: 40.0    # 房间长度 (米)
  y: 10.0    # 房间宽度 (米)
  z: 8.0     # 房间高度 (米)
```

### 无人机参数
```yaml
drone_size: 0.3    # 无人机特征尺寸，用于自适应生成障碍物
```

### 任务难度
```yaml
difficulty: 'medium'    # 'easy', 'medium', 'hard'
```

不同难度的参数：
- **Easy**: 障碍物密度0.3，最小间隙=无人机尺寸×3.0，尺寸变化0.5
- **Medium**: 障碍物密度0.5，最小间隙=无人机尺寸×2.0，尺寸变化0.7  
- **Hard**: 障碍物密度0.7，最小间隙=无人机尺寸×1.5，尺寸变化0.9

### 门配置
```yaml
gates:
  gate_1:
    type: 'square'      # 'square' 或 'circle'
    pos: [8, 0, 5]      # 位置 [x, y, z]
    size: [4, 4]        # 方形门: [宽度, 高度], 圆形门: [半径]
    direction: 'x'      # 门的朝向: 'x' 或 'y'
    clearance: 3.0      # 门前后需要保持的净空距离
```

## 输出结果

程序会在指定的输出目录中生成以下类型的图像：

1. **RGB图像** (`rgb_cam0_env*_*.png`) - 彩色渲染图像
2. **深度图像** (`depth_cam0_env*_*.png`) - 深度信息
3. **法线图像** (`normal_cam0_env*_*.png`) - 表面法线信息
4. **分割图像** (`segmentation_cam0_env*_*.png`) - 物体分割标签

## 算法原理

### 自适应障碍物生成

1. **密度计算**: 根据房间面积和难度参数计算障碍物数量
2. **尺寸生成**: 基于无人机尺寸和难度参数生成合适的障碍物尺寸
3. **位置检测**: 使用碰撞检测算法确保障碍物之间保持最小间隙
4. **类型随机**: 随机选择球体、立方体或圆柱体类型

### 门通道检测

1. **空隙检测**: 检查门前后指定距离内是否有障碍物
2. **碰撞避免**: 如果通道被阻挡，跳过该门的生成
3. **智能放置**: 确保生成的门具有实际的通过价值

### 物理仿真

- 所有障碍物和建筑结构都设置为固定物体，避免物理干扰
- 使用EzSim的刚体物理引擎进行碰撞检测
- 支持悬空障碍物的稳定放置

## 扩展功能

可以通过修改代码添加以下功能：

1. **更多障碍物类型**: 添加更复杂的几何形状
2. **动态障碍物**: 实现移动的障碍物
3. **多层环境**: 支持多楼层的复杂结构
4. **纹理材质**: 添加更真实的视觉效果
5. **传感器仿真**: 集成激光雷达、IMU等传感器

## 故障排除

1. **内存不足**: 减少并行环境数量或障碍物密度
2. **渲染问题**: 尝试使用CPU模式或降低分辨率
3. **门生成失败**: 调整门的净空距离或减少障碍物密度
4. **性能问题**: 启用性能模式 `performance_mode=True`

## 示例输出

成功运行后，你会看到类似以下的输出：
```
Generated 20 obstacles with difficulty 'medium'
Warning: Gate gate_1 has insufficient clearance, skipping
Running at 11.26 FPS (11.26 FPS per env, 1 envs)
```

这表明系统成功生成了20个障碍物，并检测到某个门的通道被阻挡而跳过。
